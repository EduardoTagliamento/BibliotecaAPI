  <!DOCTYPE html>
  <html lang="pt-BR">

  <head>
    <meta charset="UTF-8" />
    <title>CRUD Categorias com ApiService</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        padding: 2em;
      }

      table {
        margin-top: 1em;
      }
    </style>
  </head>

  <body class="container">
    <h1 class="mb-4">Gerenciamento de Categorias</h1>

    <!-- Formulário -->
    <div class="mb-3">
      <input type="number" id="txtId" class="form-control mb-2" placeholder="ID (para update ou delete)" />
      <input type="text" id="txtNomeCategoria" class="form-control mb-2" placeholder="Nome da Categoria" />
    </div>

    <div class="mb-3" id="divBotoes"></div>
    <div id="divResposta"></div>
    <div id="divTabela"></div>

    <script type="module">
      import ApiService from './ApiService.js';

      let userData = localStorage.getItem("userData");
      if (userData) {
        userData = JSON.parse(userData);
      } else {
        window.location.href = "login.html";
      }

      const token = userData.data.token;
      const api = new ApiService(token);

      let API_DATA;

      const txtId = document.getElementById("txtId");
      const txtNomeCategoria = document.getElementById("txtNomeCategoria");

      const divBotoes = document.getElementById("divBotoes");
      const divResposta = document.getElementById("divResposta");

      function createButton(text, className) {
        const btn = document.createElement("button");
        btn.textContent = text;
        btn.className = `btn ${className} me-2 mb-2`;
        return btn;
      }

      // Listar
      const btnListar = createButton("Listar", "btn-primary");
      btnListar.onclick = async function () {
        listAll();
      };
      divBotoes.appendChild(btnListar);

      // Criar
      const btnCriar = createButton("Criar", "btn-success");
      btnCriar.onclick = async function () {
        if (txtNomeCategoria.value.trim() == "") {
          divResposta.textContent = "Nome inválido";
          divResposta.className = "alert alert-danger";
          return;
        }
        const objetoCriar = {
          "categoria": {
            "nomeCategoria": txtNomeCategoria.value.trim()
          }
        };
        await api.post("../categorias", objetoCriar);
        listAll();
      };
      divBotoes.appendChild(btnCriar);

      // Atualizar Categoria
      const btnAtualizar = createButton("Atualizar", "btn-warning");
      btnAtualizar.onclick = async function () {
        const id = txtId.value.trim();
        if (!id) return alert("Informe o ID.");

        try {
          // Monta o objeto de atualização com o wrapper "Categoria"
          const objetoAtualizar = {
            "Categoria": {
              nomeCategoria: txtNomeCategoria.value.trim()
            }
          };

          // Chama o put passando a URI base, o ID e o objeto com wrapper
          await api.put("../categorias", id, objetoAtualizar);

          // Atualiza a lista
          listAll();

        } catch (error) {
          console.error("Erro ao atualizar Categoria:", error);
          alert("Não foi possível atualizar a Categoria.");
        }
      };
      divBotoes.appendChild(btnAtualizar);


      // Excluir
      const btnExcluir = createButton("Excluir", "btn-danger");
      btnExcluir.onclick = async function () {
        const id = txtId.value.trim();
        if (!id) return alert("Informe o ID.");
        await api.delete("../categorias", id);
        listAll();
      };
      divBotoes.appendChild(btnExcluir);

      async function listAll() {
        try {
          const API_DATA = await api.get("../categorias");
          if (API_DATA?.success) {
            renderTable(API_DATA);
          }
        } catch (err) {
          divResposta.textContent = "Erro ao carregar dados.";
          divResposta.className = "alert alert-danger";
        }
      }

      function renderTable(dados) {
        const divTabela = document.getElementById("divTabela");
        divTabela.innerHTML = "";

        const table = document.createElement("table");
        table.className = "table table-bordered table-striped";

        const thead = document.createElement("thead");
        thead.className = "table-light";
        const trHead = document.createElement("tr");
        ["ID", "Nome Categoria", "Ações"].forEach(text => {
          const th = document.createElement("th");
          th.textContent = text;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        dados.data.Categorias.forEach(categoria => {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.textContent = categoria.idCategoria;
          tr.appendChild(tdId);

          const tdNome = document.createElement("td");
          tdNome.textContent = categoria.nomeCategoria;
          tr.appendChild(tdNome);

          const tdAcoes = document.createElement("td");

          const btnSel = createButton("Selecionar", "btn-sm btn-info me-1");
          btnSel.onclick = function () {
            txtId.value = categoria.idCategoria;
            txtNomeCategoria.value = categoria.nomeCategoria;
            divResposta.textContent = "";
            divResposta.className = "";
          };
          tdAcoes.appendChild(btnSel);

          const btnExc = createButton("Excluir", "btn-sm btn-danger");
          btnExc.onclick = async function () {
            if (confirm(`Confirma excluir a categoria ID ${categoria.idCategoria}?`)) {
              await api.delete("../categorias", categoria.idCategoria);
              listAll();
              divResposta.textContent = `Categoria ID ${categoria.idCategoria} excluída com sucesso.`;
              divResposta.className = "alert alert-success";
            }
          };
          tdAcoes.appendChild(btnExc);

          tr.appendChild(tdAcoes);
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        divTabela.appendChild(table);
      }

      listAll();
    </script>
  </body>
  </html>
